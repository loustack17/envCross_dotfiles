#!/usr/bin/env bash
set -euo pipefail

if ! command -v nvidia-smi >/dev/null 2>&1; then
  exit 0
fi

history_dir="/tmp/waybar_gpu_history"
mkdir -p "$history_dir"

if command -v flock >/dev/null 2>&1; then
  lock_file="$history_dir/.lock"
  exec 9>"$lock_file"
  flock -x 9
fi

if ! mapfile -t rows < <(nvidia-smi --query-gpu=index,utilization.gpu,temperature.gpu --format=csv,noheader,nounits 2>/dev/null); then
  exit 0
fi
if [ "${#rows[@]}" -eq 0 ]; then
  exit 0
fi

parts=()
for row in "${rows[@]}"; do
  IFS=',' read -r idx util temp <<< "$row"
  idx="$(echo "$idx" | xargs)"
  util="$(echo "$util" | xargs)"
  temp="$(echo "$temp" | xargs)"
  if ! [[ "$idx" =~ ^[0-9]+$ && "$util" =~ ^[0-9]+([.][0-9]+)?$ && "$temp" =~ ^-?[0-9]+([.][0-9]+)?$ ]]; then
    continue
  fi

  hist_file="$history_dir/gpu_${idx}"
  printf '%s\n' "$util" >> "$hist_file"
  tmp_file="$(mktemp "${hist_file}.XXXXXX")"
  tail -n 5 "$hist_file" > "$tmp_file"
  mv "$tmp_file" "$hist_file"

  avg="$(awk '{sum+=$1} END {if (NR > 0) printf "%.1f", sum/NR; else printf "0.0"}' "$hist_file")"
  temp_fmt="$(awk -v t="$temp" 'BEGIN {printf "%.1f", t+0}')"
  parts+=("󰢮  ${avg}%  ${temp_fmt}°C")
done

if [ "${#parts[@]}" -eq 0 ]; then
  exit 0
fi

(
  IFS=' | '
  printf '%s\n' "${parts[*]}"
)
